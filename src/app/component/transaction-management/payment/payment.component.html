<div class="d-flex justify-content-between align-items-center mb-3">
  <div class="header-m-semibold">Giao dịch thanh toán</div>
  <p-button *ngIf="hasRoleExport" label="Xuất file" class="merchant-button ms-auto title-s-semibold" icon="icon-download" (click)="onExport()" [disabled]="dataTable.length <= 0"/>
</div>

<div class="wrapper">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div class="total">
      <div>Tổng giao dịch: <span>{{ totalTrans }}</span></div>
      <div>Tổng tiền: <span>{{ formatMoney(totalAmount) }}</span></div>
    </div>
    <div class="d-flex">
      <p-calendar class="merchant-calendar me-2" [iconDisplay]="'input'" [showIcon]="true" readonlyInput="true"
                  inputId="templatedisplay" selectionMode="range" [numberOfMonths]="2" [showTime]="true"
                  [hourFormat]="'24'" [(ngModel)]="searchCriteria.dateRange" [maxDate]="maxDate" [minDate]="minDate"
        (ngModelChange)="onDateRangeSelect($event)" (onClose)="onDatePickerClose()" [dateFormat]="'dd/mm/yy'">
        <ng-template pTemplate="inputicon">
          <i class="icon-calendar"></i>
        </ng-template>
      </p-calendar>
      <p-button [matBadge]="checkSearchNumber()" [ngClass]="['merchant-button-icon button-l button-light me-2', isSearch? 'active': '']"
                icon="icon-search" (click)="onToggleSearch()"/>
      <p-button [matBadge]="checkFilterNumber()" [ngClass]="['merchant-button-icon button-l button-light me-2', isFilter? 'active': '']"
                icon="icon-filter" (click)="onToggleFilter()"/>
      <p-button class="merchant-button-icon button-l button-light" icon="icon-setting" (click)="onSetting()"/>
    </div>
  </div>

  <div *ngIf="isSearch" class="box-search">
    <div class="row mb-4">
      <div class="col-md-3">
        <label class="input-label-custom">Mã giao dịch</label>
        <div class="p-inputgroup">
          <input appShowClearOnFocus=".clear-icon" class="merchant-input" pInputText placeholder="Nhập mã giao dịch" [(ngModel)]="searchCriteria.transactionCode"
            (keydown.enter)="onSearch()" />
          @if (searchCriteria.transactionCode != null && searchCriteria.transactionCode != '') {
          <span class="p-input-icon-right clear-icon" (click)="searchCriteria.transactionCode = null">
            <i class="icon-close_circle_solid input-icon input-icon-close"></i>
          </span>
          }
        </div>
      </div>
      <div class="col-md-3">
        <label class="input-label-custom">Mã FT giao dịch</label>
        <div class="p-inputgroup">
          <input appShowClearOnFocus=".clear-icon" class="merchant-input" pInputText placeholder="Nhập mã FT giao dịch"
            [(ngModel)]="searchCriteria.ftCode" (keydown.enter)="onSearch()" />
          @if (searchCriteria.ftCode != null && searchCriteria.ftCode != '') {
          <span class="p-input-icon-right clear-icon" (click)="searchCriteria.ftCode = null">
            <i class="icon-close_circle_solid input-icon input-icon-close"></i>
          </span>
          }
        </div>
      </div>
      <div class="col-md-3">
        <label class="input-label-custom">Mã đơn hàng</label>
        <div class="p-inputgroup">
          <input appShowClearOnFocus=".clear-icon" class="merchant-input" pInputText placeholder="Nhập mã đơn hàng"
            [(ngModel)]="searchCriteria.orderCode" (keydown.enter)="onSearch()" />
          @if (searchCriteria.orderCode != null && searchCriteria.orderCode != '') {
          <span class="p-input-icon-right clear-icon" (click)="searchCriteria.orderCode = null">
            <i class="icon-close_circle_solid input-icon input-icon-close"></i>
          </span>
          }
        </div>
      </div>
      <div class="col-md-3">
        <label class="input-label-custom">Mã định danh</label>
        <div class="p-inputgroup">
          <input appShowClearOnFocus=".clear-icon" class="merchant-input" pInputText placeholder="Nhập mã định danh" [(ngModel)]="searchCriteria.identifierCode"
            (keydown.enter)="onSearch()" />
          @if (searchCriteria.identifierCode != null && searchCriteria.identifierCode != '') {
          <span class="p-input-icon-right clear-icon" (click)="searchCriteria.identifierCode = null">
            <i class="icon-close_circle_solid input-icon input-icon-close"></i>
          </span>
          }
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col-md-3">
        <label class="input-label-custom">Tên tài khoản thanh toán</label>
        <div class="p-inputgroup">
          <input appShowClearOnFocus=".clear-icon" class="merchant-input" pInputText placeholder="Nhập tên tài khoản thanh toán"
            [(ngModel)]="searchCriteria.paymentAccountName" (keydown.enter)="onSearch()" />
          @if (searchCriteria.paymentAccountName != null && searchCriteria.paymentAccountName != '') {
          <span class="p-input-icon-right clear-icon" (click)="searchCriteria.paymentAccountName = null">
            <i class="icon-close_circle_solid input-icon input-icon-close"></i>
          </span>
          }
        </div>
      </div>
      <div class="col-md-3">
        <label class="input-label-custom">Số tài khoản/số thẻ</label>
        <div class="p-inputgroup">
          <input appShowClearOnFocus=".clear-icon" class="merchant-input" pInputText placeholder="Nhập số tài khoản/số thẻ"
            [(ngModel)]="searchCriteria.accountNumber" (keydown.enter)="onSearch()" />
          @if (searchCriteria.accountNumber != null && searchCriteria.accountNumber != '') {
          <span class="p-input-icon-right clear-icon" (click)="searchCriteria.accountNumber = null">
            <i class="icon-close_circle_solid input-icon input-icon-close"></i>
          </span>
          }
        </div>
      </div>
      <div class="col-md-3">
        <label class="input-label-custom">Số tiền thanh toán</label>
        <div class="p-inputgroup">
          <p-inputNumber appShowClearOnFocus=".clear-icon" class="merchant-inputNumber" inputId="integeronly" [locale]="'en-US'"
            suffix=" ₫" [min]="0" [showClear]="false" placeholder="Nhập số tiền thanh toán"
            [(ngModel)]="searchCriteria.paymentAmount" (keydown.enter)="onSearch()" />
          @if (searchCriteria.paymentAmount != null ) {
          <span class="p-input-icon-right clear-icon" (click)="searchCriteria.paymentAmount = null">
            <i class="icon-close_circle_solid input-icon input-icon-close"></i>
          </span>
          }
        </div>
      </div>
    </div>
  </div>

  <div *ngIf="isFilter" class="box-filter mt-4">
    <div class="row mb-4">
      <div class="col-md-4">
        <label class="input-label-custom">Trạng thái</label>
        <p-multiSelect class="merchant-multiSelect multiselect-all" [options]="statusOptions" optionValue="code"
          optionLabel="name" placeholder="Tất cả" [filter]="false" [(ngModel)]="filterCriteria.selectedStatuses">
          <ng-template pTemplate="selectedItems" let-selectedItems>
              <ng-container
                *ngIf="!selectedItems || selectedItems.length === 0 || selectedItems.length === statusOptions?.length">
                Tất cả
              </ng-container>
              <ng-container *ngIf="selectedItems?.length > 0 && selectedItems.length < statusOptions.length">
                {{ getSelectedNames(selectedItems) }}
              </ng-container>
            </ng-template>
        </p-multiSelect>
      </div>
      <div class="col-md-4">
          <label class="input-label-custom">Phương thức thanh toán</label>
          <mb-dropdown
            [(ngModel)]="filterCriteria.selectedPaymentMethod"
            [options]="paymentMethodOptions"
            optionValue="paymentMethodId"
            optionLabel="paymentMethodName"
            placeholder="Tất cả"
            [filter]="false"
            [showCheckmark]="true"
          ></mb-dropdown>
      </div>
      <div class="col-md-4">
        <label class="input-label-custom">Ngân hàng thanh toán</label>
        <p-dropdown
          class="merchant-dropdown"
          [options]="bankOptions"
          optionValue="code"
          optionLabel="shortName"
          placeholder="Tất cả"
          filterPlaceholder="Tìm kiếm ngân hàng" [filter]="true"
          [(ngModel)]="filterCriteria.selectedBanks"
          filterBy="shortName,fullName"
          emptyFilterMessage="Không tìm thấy dữ liệu"
          styleClass="custom-bank-multiselect">
          <ng-template let-bank pTemplate="item">
            <div class="bank-item position-relative">
              <div class="d-flex flex-column gap-2 align-items-center">
                <div class="bank-info">
                  <img [src]="assetPath + '/assets/bank/' + bank.logo"  alt="{{ bank.shortName }}" class="bank-logo" />
                  <div class="bank-name">{{ bank.shortName }}</div>
                </div>
                <div class="bank-description">{{ bank.fullName }}</div>
              </div>

              <!-- Icon tick nếu được chọn -->
              <span
                *ngIf="bank.code === filterCriteria.selectedBanks"
                class="icon-check_circle_solid"
              ></span>
            </div>
          </ng-template>
        </p-dropdown>
      </div>
    </div>
    <div class="row">
      <div class="col-md-4">
        <label class="input-label-custom">Tên nhóm</label>
        <p-treeSelect
          appendTo="body"
          [options]="groupOptions"
          [(ngModel)]="filterCriteria.selectedGroups"
          optionLabel="label"
          optionValue="key"
          selectionMode="checkbox"
          display="comma"
          [metaKeySelection]="false"
          [filter]="true"
          placeholder="Tất cả"
          class="merchant-treeSelect merchant-multiSelect merchant-tree"
          filterPlaceholder="Tìm kiếm cụm/nhóm"
          [emptyMessage]="'Không tìm thấy dữ liệu'"
          (onNodeSelect)="onGroupClick($event)"
          (onNodeUnselect)="onGroupClick($event)">
          <ng-template let-node pTemplate="default">
            <span [matTooltip]="node.fullLabel" [matTooltipDisabled]="!node.showTooltip" class="node-label-ellipsis"
              matTooltipPosition="above">
              {{ node.label }}
            </span>
          </ng-template>
        </p-treeSelect>
      </div>
      <div class="col-md-4">
        <label class="input-label-custom">Điểm kinh doanh</label>
        <p-multiSelect class="merchant-multiSelect custom-mutil-option" [options]="merchantOptions" optionValue="merchantId"
          optionLabel="merchantBizName" placeholder="Tất cả" filterPlaceHolder="Tìm kiếm điểm kinh doanh" [filter]="true"
          [(ngModel)]="filterCriteria.selectedMerchants" selectedItemsLabel="{0} điểm kinh doanh đang chọn"
          emptyFilterMessage="Không tìm thấy dữ liệu" (onPanelShow)="onMerchantDropdownShow()">
          <ng-template let-option pTemplate="item">
            <div class="ellipsis-item" [title]="option.merchantBizName">
              {{ option.merchantBizName }}
            </div>
          </ng-template>
        </p-multiSelect>
      </div>
    </div>
  </div>
  <div *ngIf="isSearch || isFilter" class="d-flex justify-content-end mt-3">
    <p-button label="Xóa bộ lọc" class="merchant-button-tertiary me-2" (click)="onReset()" [disabled]="!checkHasSearchOrFilterData()" />
    <p-button label="Áp dụng" class="merchant-button" (click)="onSearch()" />
  </div>
  <div class="mt-3">
    @if (dataTable.length > 0) {
      <grid-view class="table-transaction" [isOrder]="true" [total]="totalItem" [columns]="columns"
                 [dataSource]="dataTable" [action]="action"
                 (doChangePage)="onSearch($event)" [pageInfo]="{pageSize: this.pageSize, page: this.pageIndex,}"></grid-view>
    } @else {
      <div class="col-12 text-center mt-5 p-5">
        <img [src]="assetPath + '/assets/images/grid-search-empty.png'">
        <div class="mt-4 title-l-semibold title-no-data">Không có kết quả tìm kiếm</div>
        <div class="title-s-regular summary-no-data">Vui lòng thử lại</div>
      </div>
    }

  </div>
</div>
